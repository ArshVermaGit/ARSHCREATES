{% extends "base.html" %}

{% block title %}Admin - Feedback Management{% endblock %}

{% block content %}
<section class="section" style="padding-top: 120px;">
    <div class="container">
        <div class="section-header">
            <span class="section-tag">Admin Panel</span>
            <h2 class="section-title">Feedback Management</h2>
            <p class="section-description">View and manage contact form submissions</p>
        </div>

        <div class="liquid-base feedback-table-wrapper">
            <div class="table-controls">
                <div class="control-group">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search by name, email, or message..." aria-label="Search feedback">
                    
                    <select id="filterType" class="filter-select" aria-label="Filter by type">
                        <option value="">All Types</option>
                        <option value="collaboration">Collaboration</option>
                        <option value="game_feedback">Game Feedback</option>
                        <option value="website_feedback">Website Feedback</option>
                        <option value="photo_feedback">Photo Feedback</option>
                        <option value="video_feedback">Video Feedback</option>
                        <option value="query">General Query</option>
                        <option value="other">Other</option>
                    </select>
                    
                    <select id="dateFilter" class="filter-select" aria-label="Filter by date">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                    
                    <select id="sortOrder" class="sort-select" aria-label="Sort order">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="name_asc">Name A-Z</option>
                        <option value="name_desc">Name Z-A</option>
                        <option value="type">Type</option>
                    </select>

                    <button class="btn btn-primary" id="exportBtn"><i class="fas fa-download"></i> Export CSV</button>
                </div>
            </div>

            <div class="table-container">
                <table class="feedback-table">
                    <thead>
                        <tr>
                            <th data-sort="timestamp">Date & Time</th>
                            <th data-sort="name">Name</th>
                            <th data-sort="email">Email</th>
                            <th data-sort="phone">Phone</th>
                            <th data-sort="type">Type</th>
                            <th data-sort="message">Message</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackTableBody">
                        {% if feedbacks %}
                            {% for feedback in feedbacks %}
                            <tr data-type="{{ feedback.contact_type }}" 
                                data-timestamp="{{ feedback.timestamp }}"
                                data-name="{{ feedback.full_name|lower }}"
                                data-email="{{ feedback.email|lower }}"
                                data-phone="{{ feedback.phone or '' }}"
                                data-message="{{ feedback.comment|lower }}"
                                data-id="{{ feedback.id }}"
                                data-full-name="{{ feedback.full_name }}"
                                data-full-email="{{ feedback.email }}"
                                data-full-type="{{ feedback.contact_type.replace('_', ' ').title() }}"
                                data-full-comment="{{ feedback.comment }}">
                                <td data-sort-value="{{ feedback.timestamp }}"><div class="timestamp">{{ feedback.timestamp }}</div></td>
                                <td><strong>{{ feedback.full_name }}</strong>{% if feedback.phone and feedback.phone != 'N/A' %}<br><small style="color: var(--muted);">{{ feedback.phone }}</small>{% endif %}</td>
                                <td><a href="mailto:{{ feedback.email }}" style="color: var(--accent); text-decoration:none;">{{ feedback.email }}</a></td>
                                <td>{{ feedback.phone if feedback.phone != 'N/A' else '-' }}</td>
                                <td><span class="type-badge type-{{ feedback.contact_type }}">{{ feedback.contact_type.replace('_',' ').title() }}</span></td>
                                <td class="message-cell">
                                    <div class="message-preview" id="message-{{ feedback.id }}">{{ feedback.comment[:100] }}{% if feedback.comment|length > 100 %}...{% endif %}</div>
                                    {% if feedback.comment|length > 100 %}
                                    <button class="btn-expand-message" onclick="toggleMessage('{{ feedback.id }}')"><i class="fas fa-expand-alt"></i> Expand</button>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-view" onclick="viewMessage('{{ feedback.id }}')" title="View full message"><i class="fas fa-eye"></i></button>
                                        <button class="btn-action btn-delete" onclick="deleteFeedback('{{ feedback.id }}')" title="Delete feedback"><i class="fas fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr id="noDataRow">
                                <td colspan="7" style="text-align:center; padding:40px 20px; color:var(--muted);">
                                    <i class="fas fa-inbox" style="font-size:40px; margin-bottom:12px; display:block; opacity:0.5;"></i>
                                    <strong style="display:block; font-size:16px;">No feedback received yet</strong>
                                    <span style="font-size:13px;">Contact form submissions will appear here</span>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="table-footer">
                <div class="stats-container" style="display:flex; gap:18px; align-items:center;">
                    <div class="stat-item"><span class="stat-value" id="totalCount">{{ feedbacks|length }}</span><span class="stat-label">Total</span></div>
                    <div class="stat-item"><span class="stat-value" id="visibleCount">{{ feedbacks|length }}</span><span class="stat-label">Showing</span></div>
                </div>
                <p class="text-muted" style="margin:0; font-size:13px;">Last updated: <span id="lastUpdated">{{ now.strftime('%Y-%m-%d %H:%M') }}</span></p>
            </div>
        </div>
    </div>
</section>

<!-- Message Modal -->
<div class="portfolio-modal" id="messageModal">
    <div class="modal-overlay" onclick="closeMessageModal()"></div>
    <div class="modal-container">
        <button class="modal-close" onclick="closeMessageModal()" aria-label="Close modal"><i class="fas fa-times"></i></button>
        <div class="modal-content">
            <div class="modal-info">
                <h2 id="modalMessageTitle">Message Details</h2>
                <div id="modalMessageContent" style="line-height:1.6; max-height:400px; overflow-y:auto;"></div>
                <div class="modal-actions"><button class="btn btn-glass" onclick="closeMessageModal()"><i class="fas fa-times"></i> Close</button></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/admin_feedback_table.js') }}"></script>
<!-- (Note: admin_feedback_table.js is assumed to be your existing table script. If you don't have it explicitly separate, the inline script from your upload can be used.) -->
{% endblock %}
