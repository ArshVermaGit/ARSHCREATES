{% extends "base.html" %}

{% block title %}Admin - Feedback Management{% endblock %}

{% block content %}
<section class="section" style="padding-top: 120px;">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Feedback Management</h2>
            <p class="section-description">Manage all contact form submissions</p>
        </div>

        <!-- Stats Overview -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-value">{{ feedbacks|length }}</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayCount">0</div>
                <div class="stat-label">Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="visibleCount">{{ feedbacks|length }}</div>
                <div class="stat-label">Showing</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-grid">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search feedback..." aria-label="Search feedback">
            </div>
            
            <select id="filterType" class="filter-select">
                <option value="">All Types</option>
                <option value="Project Inquiry">Project Inquiry</option>
                <option value="Collaboration">Collaboration</option>
                <option value="Support">Support</option>
                <option value="Other">Other</option>
            </select>
            
            <select id="dateFilter" class="filter-select">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>

            <button class="btn btn-primary" id="exportBtn">
                <i class="fas fa-download"></i> Export
            </button>
        </div>

        <!-- Feedback Table -->
        <div class="table-container">
            <table class="feedback-table">
                <thead>
                    <tr>
                        <th>Contact</th>
                        <th>Type</th>
                        <th>Message</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="feedbackTableBody">
                    {% if feedbacks %}
                        {% for feedback in feedbacks %}
                        <tr class="feedback-row" 
                            data-type="{{ feedback.contact_type|lower }}" 
                            data-timestamp="{{ feedback.timestamp }}"
                            data-name="{{ feedback.full_name|lower }}"
                            data-email="{{ feedback.email|lower }}"
                            data-phone="{{ feedback.phone or ''|lower }}"
                            data-message="{{ feedback.comment|lower }}"
                            data-id="{{ feedback.id }}"
                            data-full-name="{{ feedback.full_name }}"
                            data-full-email="{{ feedback.email }}"
                            data-full-type="{{ feedback.contact_type }}"
                            data-full-comment="{{ feedback.comment }}"
                            data-date="{{ feedback.timestamp.split(' ')[0] }}">
                            
                            <td>
                                <div class="contact-info">
                                    <div class="contact-name">{{ feedback.full_name }}</div>
                                    <div class="contact-email">{{ feedback.email }}</div>
                                    {% if feedback.phone and feedback.phone != 'N/A' %}
                                    <div class="contact-phone">{{ feedback.phone }}</div>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td>
                                <span class="type-badge type-{{ feedback.contact_type|lower|replace(' ', '-') }}">
                                    {{ feedback.contact_type }}
                                </span>
                            </td>
                            
                            <td>
                                <div class="message-preview">
                                    {{ feedback.comment[:80] }}{% if feedback.comment|length > 80 %}...{% endif %}
                                </div>
                            </td>
                            
                            <td>
                                <div class="timestamp">
                                    <div class="date">{{ feedback.timestamp.split(' ')[0] }}</div>
                                    <div class="time">{{ feedback.timestamp.split(' ')[1] }}</div>
                                </div>
                            </td>
                            
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action view-btn" onclick="viewMessage('{{ feedback.id }}')" title="View message">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-action delete-btn" onclick="deleteFeedback('{{ feedback.id }}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <h3>No feedback yet</h3>
                                <p>Contact form submissions will appear here</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Message Modal -->
<div class="modal" id="messageModal" style="display: none;">
    <div class="modal-overlay" onclick="closeMessageModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalMessageTitle">Message Details</h3>
            <button class="modal-close" onclick="closeMessageModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="modalMessageContent">
            <!-- Message content will be inserted here -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="replyToCurrentMessage()">
                <i class="fas fa-reply"></i> Reply
            </button>
            <button class="btn btn-secondary" onclick="closeMessageModal()">
                Close
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
// Wait for main.js to load, then initialize admin functions
document.addEventListener('DOMContentLoaded', function() {
    // Give main.js time to load
    setTimeout(function() {
        if (typeof initAdminFunctions === 'function') {
            initAdminFunctions();
        } else {
            console.error('initAdminFunctions not found in main.js');
        }
        
        if (typeof updateTodayCount === 'function') {
            updateTodayCount();
        }
    }, 100);
});
</script>
{% endblock %}