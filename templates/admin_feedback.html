{% extends "base.html" %}
{% block title %}Admin - Feedback Management{% endblock %}
{% block content %}
<!-- ADMIN FEEDBACK SECTION -->
<section class="section" style="padding-top: 140px;">
    <div class="container">
        <div class="section-header">
            <span class="section-tag">Admin Panel</span>
            <h2 class="section-title">Feedback Management</h2>
            <p class="section-description">View and manage all contact form submissions with advanced filtering and sorting</p>
        </div>

        <div class="liquid-base feedback-table-wrapper">
            <div class="table-controls">
                <div class="control-group">
                    <input type="text" 
                           id="searchInput" 
                           class="search-input" 
                           placeholder="Search by name, email, or message..."
                           aria-label="Search feedback">
                    
                    <select id="filterType" class="filter-select" aria-label="Filter by type">
                        <option value="">All Types</option>
                        <option value="collaboration">Collaboration</option>
                        <option value="game_feedback">Game Feedback</option>
                        <option value="website_feedback">Website Feedback</option>
                        <option value="photo_feedback">Photo Feedback</option>
                        <option value="video_feedback">Video Feedback</option>
                        <option value="query">General Query</option>
                        <option value="other">Other</option>
                    </select>
                    
                    <select id="dateFilter" class="filter-select" aria-label="Filter by date">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                    
                    <select id="sortOrder" class="sort-select" aria-label="Sort order">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="name_asc">Name A-Z</option>
                        <option value="name_desc">Name Z-A</option>
                        <option value="type">Type</option>
                    </select>

                    <button class="btn btn-primary" id="exportBtn">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="feedback-table">
                    <thead>
                        <tr>
                            <th data-sort="timestamp">Date & Time</th>
                            <th data-sort="name">Name</th>
                            <th data-sort="email">Email</th>
                            <th data-sort="phone">Phone</th>
                            <th data-sort="type">Type</th>
                            <th data-sort="message">Message</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackTableBody">
                        {% if feedbacks %}
                            {% for feedback in feedbacks %}
                            <tr data-type="{{ feedback.contact_type }}" 
                                data-timestamp="{{ feedback.timestamp }}"
                                data-name="{{ feedback.full_name|lower }}"
                                data-email="{{ feedback.email|lower }}"
                                data-phone="{{ feedback.phone or '' }}"
                                data-message="{{ feedback.comment|lower }}"
                                data-id="{{ feedback.id }}"
                                data-full-name="{{ feedback.full_name }}"
                                data-full-email="{{ feedback.email }}"
                                data-full-type="{{ feedback.contact_type.replace('_', ' ').title() }}"
                                data-full-comment="{{ feedback.comment }}">
                                <td data-sort-value="{{ feedback.timestamp }}">
                                    <div class="timestamp">{{ feedback.timestamp }}</div>
                                </td>
                                <td>
                                    <strong>{{ feedback.full_name }}</strong>
                                    {% if feedback.phone and feedback.phone != 'N/A' %}
                                    <br><small style="color: var(--text-secondary);">{{ feedback.phone }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="mailto:{{ feedback.email }}" style="color: var(--accent); text-decoration: none;">
                                        {{ feedback.email }}
                                    </a>
                                </td>
                                <td>{{ feedback.phone if feedback.phone != 'N/A' else '-' }}</td>
                                <td>
                                    <span class="type-badge type-{{ feedback.contact_type }}">
                                        {{ feedback.contact_type.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td class="message-cell">
                                    <div class="message-preview" id="message-{{ feedback.id }}">
                                        {{ feedback.comment[:100] }}{% if feedback.comment|length > 100 %}...{% endif %}
                                    </div>
                                    {% if feedback.comment|length > 100 %}
                                    <button class="btn-expand-message" onclick="toggleMessage('{{ feedback.id }}')">
                                        <i class="fas fa-expand-alt"></i>
                                    </button>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-glass" onclick="showMessageModal('{{ feedback.id }}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="btn btn-glass" onclick="deleteFeedback('{{ feedback.id }}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr id="noDataRow">
                                <td colspan="7" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.5;"></i>
                                    <strong style="display: block; font-size: 18px; margin-bottom: 8px;">No feedback received yet</strong>
                                    <span style="font-size: 14px;">Contact form submissions will appear here</span>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="table-footer">
                <p>Total: <span id="totalCount">{{ feedbacks|length }}</span> | Visible: <span id="visibleCount">{{ feedbacks|length }}</span></p>
            </div>
        </div>
    </div>
</section>

<!-- MODAL FOR FULL MESSAGE -->
<div id="messageModal" class="portfolio-modal">
    <div class="modal-overlay" onclick="closeMessageModal()"></div>
    <div class="modal-container">
        <button class="modal-close" onclick="closeMessageModal()">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-content">
            <h2 id="messageModalTitle" class="modal-title"></h2>
            <p id="messageModalMeta" class="modal-meta"></p>
            <div id="messageModalContent" class="modal-message"></div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT FOR ADMIN FUNCTIONALITY -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const filterType = document.getElementById('filterType');
    const dateFilter = document.getElementById('dateFilter');
    const sortOrder = document.getElementById('sortOrder');
    const exportBtn = document.getElementById('exportBtn');
    const feedbackTableBody = document.getElementById('feedbackTableBody');
    const totalCount = document.getElementById('totalCount');
    const visibleCount = document.getElementById('visibleCount');

    function updateTable() {
        const rows = feedbackTableBody.querySelectorAll('tr:not(#noDataRow)');
        const searchValue = searchInput.value.toLowerCase();
        const typeValue = filterType.value;
        const dateValue = dateFilter.value;

        let visibleRows = 0;

        rows.forEach(row => {
            const name = row.dataset.name;
            const email = row.dataset.email;
            const message = row.dataset.message;
            const type = row.dataset.type;
            const timestamp = row.dataset.timestamp;

            let matchesSearch = !searchValue || 
                name.includes(searchValue) || 
                email.includes(searchValue) || 
                message.includes(searchValue);

            let matchesType = !typeValue || type === typeValue;

            let matchesDate = true;
            if (dateValue) {
                const date = new Date(timestamp);
                const now = new Date();
                if (dateValue === 'today') {
                    matchesDate = date.toDateString() === now.toDateString();
                } else if (dateValue === 'week') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    matchesDate = date >= weekAgo;
                } else if (dateValue === 'month') {
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    matchesDate = date >= monthAgo;
                }
            }

            if (matchesSearch && matchesType && matchesDate) {
                row.style.display = '';
                visibleRows++;
            } else {
                row.style.display = 'none';
            }
        });

        visibleCount.textContent = visibleRows;

        const noDataRow = document.getElementById('noDataRow');
        if (visibleRows === 0 && noDataRow) {
            noDataRow.style.display = '';
        } else if (noDataRow) {
            noDataRow.style.display = 'none';
        }
    }

    window.toggleMessage = function(id) {
        const messageDiv = document.getElementById(`message-${id}`);
        const row = messageDiv.closest('tr');
        const fullMessage = row.dataset.fullComment;
        const isExpanded = messageDiv.classList.contains('expanded');

        if (isExpanded) {
            messageDiv.textContent = fullMessage.substring(0, 100) + (fullMessage.length > 100 ? '...' : '');
            messageDiv.classList.remove('expanded');
        } else {
            messageDiv.textContent = fullMessage;
            messageDiv.classList.add('expanded');
        }
    };

    window.showMessageModal = function(id) {
        const row = document.querySelector(`tr[data-id="${id}"]`);
        const modal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('messageModalTitle');
        const modalMeta = document.getElementById('messageModalMeta');
        const modalContent = document.getElementById('messageModalContent');

        modalTitle.textContent = row.dataset.fullName;
        modalMeta.innerHTML = `
            <strong>Email:</strong> <a href="mailto:${row.dataset.fullEmail}">${row.dataset.fullEmail}</a><br>
            <strong>Type:</strong> ${row.dataset.fullType}<br>
            <strong>Date:</strong> ${row.dataset.timestamp}
        `;
        modalContent.textContent = row.dataset.fullComment;

        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    };

    window.closeMessageModal = function() {
        const modal = document.getElementById('messageModal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    };

    window.deleteFeedback = async function(id) {
        if (!confirm('Are you sure you want to delete this feedback?')) return;

        try {
            const response = await fetch(`/delete_feedback/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                throw new Error('Failed to delete feedback');
            }

            const result = await response.json();
            if (result.success) {
                const row = document.querySelector(`tr[data-id="${id}"]`);
                row.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    row.remove();
                    updateTable();
                    showNotification('Feedback deleted successfully', 'success');
                }, 300);
            } else {
                throw new Error(result.error || 'Failed to delete feedback');
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    };

    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const search = searchInput.value;
            const type = filterType.value;
            const date = dateFilter.value;
            const url = `/export_feedback_csv?search=${encodeURIComponent(search)}&type=${encodeURIComponent(type)}&date=${encodeURIComponent(date)}`;
            window.location.href = url;
        });
    }

    [searchInput, filterType, dateFilter, sortOrder].forEach(element => {
        if (element) {
            element.addEventListener('input', updateTable);
            element.addEventListener('change', updateTable);
        }
    });

    sortOrder.addEventListener('change', function() {
        const rows = Array.from(feedbackTableBody.querySelectorAll('tr:not(#noDataRow)'));
        const value = sortOrder.value;

        rows.sort((a, b) => {
            let aValue, bValue;
            if (value === 'newest') {
                aValue = new Date(a.dataset.timestamp);
                bValue = new Date(b.dataset.timestamp);
                return bValue - aValue;
            } else if (value === 'oldest') {
                aValue = new Date(a.dataset.timestamp);
                bValue = new Date(b.dataset.timestamp);
                return aValue - bValue;
            } else if (value === 'name_asc') {
                aValue = a.dataset.name;
                bValue = b.dataset.name;
                return aValue.localeCompare(bValue);
            } else if (value === 'name_desc') {
                aValue = a.dataset.name;
                bValue = b.dataset.name;
                return bValue.localeCompare(aValue);
            } else if (value === 'type') {
                aValue = a.dataset.type;
                bValue = b.dataset.type;
                return aValue.localeCompare(bValue);
            }
        });

        feedbackTableBody.innerHTML = '';
        rows.forEach(row => feedbackTableBody.appendChild(row));
        updateTable();
    });

    updateTable();
});
</script>
{% endblock %}